"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.serializer = exports.makeDeserializer = undefined;

var _transitJs = require("transit-js");

var _transitJs2 = _interopRequireDefault(_transitJs);

var _immutable = require("immutable");

var _syntax = require("./syntax");

var _syntax2 = _interopRequireDefault(_syntax);

var _symbol = require("./symbol");

var _tokenizer = require("shift-parser/dist/tokenizer");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

let typeMap = [_tokenizer.TokenType.STRING, _tokenizer.TokenType.EOS, _tokenizer.TokenType.LPAREN, _tokenizer.TokenType.RPAREN, _tokenizer.TokenType.LBRACK, _tokenizer.TokenType.RBRACK, _tokenizer.TokenType.LBRACE, _tokenizer.TokenType.RBRACE, _tokenizer.TokenType.COLON, _tokenizer.TokenType.SEMICOLON, _tokenizer.TokenType.PERIOD, _tokenizer.TokenType.ELLIPSIS, _tokenizer.TokenType.ARROW, _tokenizer.TokenType.CONDITIONAL, _tokenizer.TokenType.INC, _tokenizer.TokenType.DEC, _tokenizer.TokenType.ASSIGN, _tokenizer.TokenType.ASSIGN_BIT_OR, _tokenizer.TokenType.ASSIGN_BIT_XOR, _tokenizer.TokenType.ASSIGN_BIT_AND, _tokenizer.TokenType.ASSIGN_SHL, _tokenizer.TokenType.ASSIGN_SHR, _tokenizer.TokenType.ASSIGN_SHR_UNSIGNED, _tokenizer.TokenType.ASSIGN_ADD, _tokenizer.TokenType.ASSIGN_SUB, _tokenizer.TokenType.ASSIGN_MUL, _tokenizer.TokenType.ASSIGN_DIV, _tokenizer.TokenType.ASSIGN_MOD, _tokenizer.TokenType.COMMA, _tokenizer.TokenType.OR, _tokenizer.TokenType.AND, _tokenizer.TokenType.BIT_OR, _tokenizer.TokenType.BIT_XOR, _tokenizer.TokenType.BIT_AND, _tokenizer.TokenType.SHL, _tokenizer.TokenType.SHR, _tokenizer.TokenType.SHR_UNSIGNED, _tokenizer.TokenType.ADD, _tokenizer.TokenType.SUB, _tokenizer.TokenType.MUL, _tokenizer.TokenType.DIV, _tokenizer.TokenType.MOD, _tokenizer.TokenType.EQ, _tokenizer.TokenType.NE, _tokenizer.TokenType.EQ_STRICT, _tokenizer.TokenType.NE_STRICT, _tokenizer.TokenType.LT, _tokenizer.TokenType.GT, _tokenizer.TokenType.LTE, _tokenizer.TokenType.GTE, _tokenizer.TokenType.INSTANCEOF, _tokenizer.TokenType.IN, _tokenizer.TokenType.NOT, _tokenizer.TokenType.BIT_NOT, _tokenizer.TokenType.AWAIT, _tokenizer.TokenType.DELETE, _tokenizer.TokenType.TYPEOF, _tokenizer.TokenType.VOID, _tokenizer.TokenType.BREAK, _tokenizer.TokenType.CASE, _tokenizer.TokenType.CATCH, _tokenizer.TokenType.CLASS, _tokenizer.TokenType.CONTINUE, _tokenizer.TokenType.DEBUGGER, _tokenizer.TokenType.DEFAULT, _tokenizer.TokenType.DO, _tokenizer.TokenType.ELSE, _tokenizer.TokenType.EXPORT, _tokenizer.TokenType.EXTENDS, _tokenizer.TokenType.FINALLY, _tokenizer.TokenType.FOR, _tokenizer.TokenType.FUNCTION, _tokenizer.TokenType.IF, _tokenizer.TokenType.IMPORT, _tokenizer.TokenType.LET, _tokenizer.TokenType.NEW, _tokenizer.TokenType.RETURN, _tokenizer.TokenType.SUPER, _tokenizer.TokenType.SWITCH, _tokenizer.TokenType.THIS, _tokenizer.TokenType.THROW, _tokenizer.TokenType.TRY, _tokenizer.TokenType.VAR, _tokenizer.TokenType.WHILE, _tokenizer.TokenType.WITH, _tokenizer.TokenType.NULL, _tokenizer.TokenType.TRUE, _tokenizer.TokenType.FALSE, _tokenizer.TokenType.YIELD, _tokenizer.TokenType.NUMBER, _tokenizer.TokenType.STRING, _tokenizer.TokenType.REGEXP, _tokenizer.TokenType.IDENTIFIER, _tokenizer.TokenType.CONST, _tokenizer.TokenType.TEMPLATE, _tokenizer.TokenType.ILLEGAL];

let ListHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "array",
  rep: v => v
});

let MapHandler = _transitJs2.default.makeWriteHandler({
  tag: function tag() {
    return "map";
  },
  rep: function rep(v) {
    return v;
  },
  stringRep: function stringRep() {
    return null;
  }
});

let SyntaxHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "stx",
  rep: v => {
    if (_immutable.List.isList(v.token)) {
      return [v.token, v.scopesets];
    } else {
      let t = _transitJs2.default.objectToMap(v.token);
      t.set("type", typeMap.indexOf(v.token.type));
      return [t, v.scopesets];
    }
  }
});
let SymbolHandler = _transitJs2.default.makeWriteHandler({
  tag: () => "symb",
  rep: v => [v.name]
});

let writer = _transitJs2.default.writer("json", {
  handlers: _transitJs2.default.map([_immutable.List, ListHandler, _immutable.Map, MapHandler, _syntax2.default, SyntaxHandler, _symbol.SymbolClass, SymbolHandler])
});

function makeReader(bindings) {
  return _transitJs2.default.reader("json", {
    arrayBuilder: {
      init: () => (0, _immutable.List)().asMutable(),
      add: (ret, val) => ret.push(val),
      finalize: ret => ret.asImmutable(),
      fromArray: arr => (0, _immutable.List)(arr)
    },
    mapBuilder: {
      init: function init() {
        return (0, _immutable.Map)().asMutable();
      },
      add: function add(ret, key, val) {
        return ret.set(key, val);
      },
      finalize: function finalize(ret) {
        return ret.asImmutable();
      }
    },
    handlers: {
      "stx": rep => {
        let scopesets = _transitJs2.default.mapToObject(rep[1]);
        if (_immutable.List.isList(rep[0])) {
          let token = rep[0];
          return new _syntax2.default(token, { bindings: bindings, scopesets: scopesets });
        } else {
          let token = _transitJs2.default.mapToObject(rep[0]);
          token.type = typeMap[rep[0].get("type")];
          token.slice = rep[0].has("slice") ? _transitJs2.default.mapToObject(rep[0].get("slice")) : undefined;
          if (token.slice) {
            token.slice.startLocation = _transitJs2.default.mapToObject(token.slice.startLocation);
          }
          return new _syntax2.default(token, { bindings: bindings, scopesets: scopesets });
        }
      },
      "symb": rep => {
        return (0, _symbol.Symbol)(rep[0]);
      }
    }
  });
}

exports.makeDeserializer = makeReader;
exports.serializer = writer;
//# sourceMappingURL=data:application/json;base64,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UUFBUSxJQUFJLENBQUosRUFBTyxHQUFQLENBQVcsTUFBWCxDQUFSLENBQWI7QUFDQSxnQkFBTSxLQUFOLEdBQWMsSUFBSSxDQUFKLEVBQU8sR0FBUCxDQUFXLE9BQVgsSUFBc0Isb0JBQVEsV0FBUixDQUFvQixJQUFJLENBQUosRUFBTyxHQUFQLENBQVcsT0FBWCxDQUFwQixDQUF0QixHQUFpRSxTQUEvRTtBQUNBLGNBQUksTUFBTSxLQUFWLEVBQWlCO0FBQ2Ysa0JBQU0sS0FBTixDQUFZLGFBQVosR0FBNEIsb0JBQVEsV0FBUixDQUFvQixNQUFNLEtBQU4sQ0FBWSxhQUFoQyxDQUE1QjtBQUNEO0FBQ0QsaUJBQU8scUJBQVcsS0FBWCxFQUFrQixFQUFDLGtCQUFELEVBQVcsV0FBVyxTQUF0QixFQUFsQixDQUFQO0FBQ0Q7QUFDRixPQWZPO0FBZ0JSLGNBQVMsR0FBRCxJQUFTO0FBQ2YsZUFBTyxvQkFBTyxJQUFJLENBQUosQ0FBUCxDQUFQO0FBQ0Q7QUFsQk87QUFaa0IsR0FBdkIsQ0FBUDtBQWlDRDs7UUFHZSxnQixHQUFkLFU7UUFBMEMsVSxHQUFWLE0iLCJmaWxlIjoic2VyaWFsaXplci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0cmFuc2l0IGZyb20gXCJ0cmFuc2l0LWpzXCI7XG5pbXBvcnQgeyBMaXN0LCBNYXAgfSBmcm9tIFwiaW1tdXRhYmxlXCI7XG5pbXBvcnQgU3ludGF4IGZyb20gXCIuL3N5bnRheFwiO1xuaW1wb3J0IHsgU3ltYm9sLCAgU3ltYm9sQ2xhc3MgfSBmcm9tIFwiLi9zeW1ib2xcIjtcbmltcG9ydCB7IFRva2VuVHlwZSB9IGZyb20gXCJzaGlmdC1wYXJzZXIvZGlzdC90b2tlbml6ZXJcIjtcblxubGV0IHR5cGVNYXAgPSBbVG9rZW5UeXBlLlNUUklORywgVG9rZW5UeXBlLkVPUywgVG9rZW5UeXBlLkxQQVJFTiwgVG9rZW5UeXBlLlJQQVJFTixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5MQlJBQ0ssIFRva2VuVHlwZS5SQlJBQ0ssIFRva2VuVHlwZS5MQlJBQ0UsIFRva2VuVHlwZS5SQlJBQ0UsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuQ09MT04sIFRva2VuVHlwZS5TRU1JQ09MT04sIFRva2VuVHlwZS5QRVJJT0QsIFRva2VuVHlwZS5FTExJUFNJUyxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5BUlJPVywgVG9rZW5UeXBlLkNPTkRJVElPTkFMLCBUb2tlblR5cGUuSU5DLCBUb2tlblR5cGUuREVDLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkFTU0lHTiwgVG9rZW5UeXBlLkFTU0lHTl9CSVRfT1IsIFRva2VuVHlwZS5BU1NJR05fQklUX1hPUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5BU1NJR05fQklUX0FORCwgVG9rZW5UeXBlLkFTU0lHTl9TSEwsIFRva2VuVHlwZS5BU1NJR05fU0hSLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkFTU0lHTl9TSFJfVU5TSUdORUQsIFRva2VuVHlwZS5BU1NJR05fQURELCBUb2tlblR5cGUuQVNTSUdOX1NVQixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5BU1NJR05fTVVMLCBUb2tlblR5cGUuQVNTSUdOX0RJViwgVG9rZW5UeXBlLkFTU0lHTl9NT0QsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuQ09NTUEsIFRva2VuVHlwZS5PUiwgVG9rZW5UeXBlLkFORCwgVG9rZW5UeXBlLkJJVF9PUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5CSVRfWE9SLCBUb2tlblR5cGUuQklUX0FORCwgVG9rZW5UeXBlLlNITCwgVG9rZW5UeXBlLlNIUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5TSFJfVU5TSUdORUQsIFRva2VuVHlwZS5BREQsIFRva2VuVHlwZS5TVUIsIFRva2VuVHlwZS5NVUwsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuRElWLCBUb2tlblR5cGUuTU9ELCBUb2tlblR5cGUuRVEsIFRva2VuVHlwZS5ORSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5FUV9TVFJJQ1QsIFRva2VuVHlwZS5ORV9TVFJJQ1QsIFRva2VuVHlwZS5MVCwgVG9rZW5UeXBlLkdULFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkxURSwgVG9rZW5UeXBlLkdURSwgVG9rZW5UeXBlLklOU1RBTkNFT0YsIFRva2VuVHlwZS5JTixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5OT1QsIFRva2VuVHlwZS5CSVRfTk9ULCBUb2tlblR5cGUuQVdBSVQsIFRva2VuVHlwZS5ERUxFVEUsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuVFlQRU9GLCBUb2tlblR5cGUuVk9JRCwgVG9rZW5UeXBlLkJSRUFLLCBUb2tlblR5cGUuQ0FTRSxcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5DQVRDSCwgVG9rZW5UeXBlLkNMQVNTLCBUb2tlblR5cGUuQ09OVElOVUUsIFRva2VuVHlwZS5ERUJVR0dFUixcbiAgICAgICAgICAgICAgIFRva2VuVHlwZS5ERUZBVUxULCBUb2tlblR5cGUuRE8sIFRva2VuVHlwZS5FTFNFLCBUb2tlblR5cGUuRVhQT1JULFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLkVYVEVORFMsIFRva2VuVHlwZS5GSU5BTExZLCBUb2tlblR5cGUuRk9SLCBUb2tlblR5cGUuRlVOQ1RJT04sXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuSUYsIFRva2VuVHlwZS5JTVBPUlQsIFRva2VuVHlwZS5MRVQsIFRva2VuVHlwZS5ORVcsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuUkVUVVJOLCBUb2tlblR5cGUuU1VQRVIsIFRva2VuVHlwZS5TV0lUQ0gsIFRva2VuVHlwZS5USElTLFxuICAgICAgICAgICAgICAgVG9rZW5UeXBlLlRIUk9XLCBUb2tlblR5cGUuVFJZLCBUb2tlblR5cGUuVkFSLCBUb2tlblR5cGUuV0hJTEUsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuV0lUSCwgVG9rZW5UeXBlLk5VTEwsIFRva2VuVHlwZS5UUlVFLCBUb2tlblR5cGUuRkFMU0UsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuWUlFTEQsIFRva2VuVHlwZS5OVU1CRVIsIFRva2VuVHlwZS5TVFJJTkcsIFRva2VuVHlwZS5SRUdFWFAsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuSURFTlRJRklFUiwgVG9rZW5UeXBlLkNPTlNULCBUb2tlblR5cGUuVEVNUExBVEUsXG4gICAgICAgICAgICAgICBUb2tlblR5cGUuSUxMRUdBTF07XG5cbmxldCBMaXN0SGFuZGxlciA9IHRyYW5zaXQubWFrZVdyaXRlSGFuZGxlcih7XG4gIHRhZzogKCkgPT4gXCJhcnJheVwiLFxuICByZXA6ICh2KSA9PiB2XG59KTtcblxubGV0IE1hcEhhbmRsZXIgPSB0cmFuc2l0Lm1ha2VXcml0ZUhhbmRsZXIoe1xuICB0YWc6IGZ1bmN0aW9uKCkgeyByZXR1cm4gXCJtYXBcIjsgfSxcbiAgcmVwOiBmdW5jdGlvbih2KSB7IHJldHVybiB2OyB9LFxuICBzdHJpbmdSZXA6IGZ1bmN0aW9uKCkgeyByZXR1cm4gbnVsbDsgfVxufSk7XG5cbmxldCBTeW50YXhIYW5kbGVyID0gdHJhbnNpdC5tYWtlV3JpdGVIYW5kbGVyKHtcbiAgdGFnOiAoKSA9PiBcInN0eFwiLFxuICByZXA6ICh2KSA9PiB7XG4gICAgaWYgKExpc3QuaXNMaXN0KHYudG9rZW4pKSB7XG4gICAgICByZXR1cm4gW3YudG9rZW4sIHYuc2NvcGVzZXRzXTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHQgPSB0cmFuc2l0Lm9iamVjdFRvTWFwKHYudG9rZW4pO1xuICAgICAgdC5zZXQoXCJ0eXBlXCIsIHR5cGVNYXAuaW5kZXhPZih2LnRva2VuLnR5cGUpKTtcbiAgICAgIHJldHVybiBbdCwgdi5zY29wZXNldHNdO1xuICAgIH1cbiAgfVxufSk7XG5sZXQgU3ltYm9sSGFuZGxlciA9IHRyYW5zaXQubWFrZVdyaXRlSGFuZGxlcih7XG4gIHRhZzogKCkgPT4gXCJzeW1iXCIsXG4gIHJlcDogKHYpID0+ICBbdi5uYW1lXVxufSk7XG5cbmxldCB3cml0ZXIgPSB0cmFuc2l0LndyaXRlcihcImpzb25cIiwge1xuICBoYW5kbGVyczogdHJhbnNpdC5tYXAoW1xuICAgIExpc3QsIExpc3RIYW5kbGVyLFxuICAgIE1hcCwgTWFwSGFuZGxlcixcbiAgICBTeW50YXgsIFN5bnRheEhhbmRsZXIsXG4gICAgU3ltYm9sQ2xhc3MsIFN5bWJvbEhhbmRsZXJcbiAgXSlcbn0pO1xuXG5mdW5jdGlvbiBtYWtlUmVhZGVyKGJpbmRpbmdzKSB7XG4gIHJldHVybiB0cmFuc2l0LnJlYWRlcihcImpzb25cIiwge1xuICAgIGFycmF5QnVpbGRlcjoge1xuICAgICAgaW5pdDogKCkgPT4gTGlzdCgpLmFzTXV0YWJsZSgpLFxuICAgICAgYWRkOiAocmV0LCB2YWwpID0+IHJldC5wdXNoKHZhbCksXG4gICAgICBmaW5hbGl6ZTogKHJldCkgPT4gcmV0LmFzSW1tdXRhYmxlKCksXG4gICAgICBmcm9tQXJyYXk6IChhcnIpID0+IExpc3QoYXJyKVxuICAgIH0sXG4gICAgbWFwQnVpbGRlcjoge1xuICAgICAgaW5pdDogZnVuY3Rpb24oKSB7IHJldHVybiBNYXAoKS5hc011dGFibGUoKTsgfSxcbiAgICAgIGFkZDogZnVuY3Rpb24ocmV0LCBrZXksIHZhbCkgeyByZXR1cm4gcmV0LnNldChrZXksIHZhbCk7IH0sXG4gICAgICBmaW5hbGl6ZTogZnVuY3Rpb24ocmV0KSB7IHJldHVybiByZXQuYXNJbW11dGFibGUoKTsgfVxuICAgIH0sXG4gICAgaGFuZGxlcnM6IHtcbiAgICAgIFwic3R4XCI6IChyZXApID0+IHtcbiAgICAgICAgbGV0IHNjb3Blc2V0cyA9IHRyYW5zaXQubWFwVG9PYmplY3QocmVwWzFdKTtcbiAgICAgICAgaWYgKExpc3QuaXNMaXN0KHJlcFswXSkpIHtcbiAgICAgICAgICBsZXQgdG9rZW4gPSByZXBbMF07XG4gICAgICAgICAgcmV0dXJuIG5ldyBTeW50YXgodG9rZW4sIHtiaW5kaW5ncywgc2NvcGVzZXRzOiBzY29wZXNldHN9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsZXQgdG9rZW4gPSB0cmFuc2l0Lm1hcFRvT2JqZWN0KHJlcFswXSk7XG4gICAgICAgICAgdG9rZW4udHlwZSA9IHR5cGVNYXBbcmVwWzBdLmdldChcInR5cGVcIildO1xuICAgICAgICAgIHRva2VuLnNsaWNlID0gcmVwWzBdLmhhcyhcInNsaWNlXCIpID8gdHJhbnNpdC5tYXBUb09iamVjdChyZXBbMF0uZ2V0KFwic2xpY2VcIikpIDogdW5kZWZpbmVkO1xuICAgICAgICAgIGlmICh0b2tlbi5zbGljZSkge1xuICAgICAgICAgICAgdG9rZW4uc2xpY2Uuc3RhcnRMb2NhdGlvbiA9IHRyYW5zaXQubWFwVG9PYmplY3QodG9rZW4uc2xpY2Uuc3RhcnRMb2NhdGlvbik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBuZXcgU3ludGF4KHRva2VuLCB7YmluZGluZ3MsIHNjb3Blc2V0czogc2NvcGVzZXRzfSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBcInN5bWJcIjogKHJlcCkgPT4ge1xuICAgICAgICByZXR1cm4gU3ltYm9sKHJlcFswXSk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuZXhwb3J0IHtcbiAgbWFrZVJlYWRlciBhcyBtYWtlRGVzZXJpYWxpemVyLCB3cml0ZXIgYXMgc2VyaWFsaXplclxufTtcbiJdfQ==